EMPTY_AUTOMAKE_TARGETS  = install-info installdirs check installcheck dvi pdf
EMPTY_AUTOMAKE_TARGETS += ps info html tags ctags distdir

BOTNETCFG	= ../../bin/botnet-config
MYSQLCFG	= mysql_config
PKGCONFIGPATH	= ../../lib/pkgconfig
LUACFG		= lua-config

CC	= @CC@

DESTDIR		=
prefix		= @prefix@
datadir		= @datadir@
pkglibdir	= ${datadir}/beirdobot/plugins

CFLAGS	= -O6 -g -Wall -Werror -I../../include -std=c99 -pedantic
# -DDEBUG
CFLAGS	+= $(shell ${MYSQLCFG} --cflags)
CFLAGS  += $(shell ${BOTNETCFG} --cflags)

LDFLAGS = -g
LIBS	= $(shell ${MYSQLCFG} --libs_r)
LIBS	+= $(shell ${BOTNETCFG} --libs-static)

SRCS    = core.c

PLUGIN_DNS       = @PLUGIN_DNS@
ifeq (${PLUGIN_DNS},yes)
 SRCS  += dns.c
 DLLIBS_dns	= -lresolv
endif

PLUGIN_FART      = @PLUGIN_FART@
ifeq (${PLUGIN_FART},yes)
 SRCS  += fart.c
endif

PLUGIN_LUASCRIPT = @PLUGIN_LUASCRIPT@
ifeq (${PLUGIN_LUASCRIPT},yes)
 SRCS  += luascript.c
 CFLAGS_luascript  = $(shell ${LUACFG} --include)
 CFLAGS_luascript += -DPLUGIN_PATH=\"${pkglibdir}\"
 DLLIBS_luascript  = $(shell ${LUACFG} --libs)
 LUASCRIPTS = burp.lua
endif

PLUGIN_MAILBOX   = @PLUGIN_MAILBOX@
ifeq (${PLUGIN_MAILBOX},yes)
 SRCS  += mailbox.c
 DLLIBS_mailbox	= -lc-client
endif

PLUGIN_RSSFEED   = @PLUGIN_RSSFEED@
ifeq (${PLUGIN_RSSFEED},yes)
 SRCS  += rssfeed.c
 CFLAGS_rssfeed  = $(shell PKG_CONFIG_PATH=${PKGCONFIGPATH} pkg-config --cflags nxml)
 CFLAGS_rssfeed += $(shell PKG_CONFIG_PATH=${PKGCONFIGPATH} pkg-config --cflags mrss)
 DLLIBS_rssfeed  = $(shell PKG_CONFIG_PATH=${PKGCONFIGPATH} pkg-config --libs nxml)
 DLLIBS_rssfeed += $(shell PKG_CONFIG_PATH=${PKGCONFIGPATH} pkg-config --libs mrss)
 DLLIBS_rssfeed += -lcurl
endif

PLUGIN_TRAC      = @PLUGIN_TRAC@
ifeq (${PLUGIN_TRAC},yes)
 SRCS  += trac.c
 CFLAGS_trac  = -I/usr/include/subversion-1 -I/usr/include/apr-0
 CFLAGS_trac += $(shell PKG_CONFIG_PATH=${PKGCONFIGPATH} pkg-config --cflags nxml)
 CFLAGS_trac += $(shell PKG_CONFIG_PATH=${PKGCONFIGPATH} pkg-config --cflags mrss)
 DLLIBS_trac  = -lsvn_client-1 -lapr-0 -laprutil-0
 DLLIBS_trac += $(shell PKG_CONFIG_PATH=${PKGCONFIGPATH} pkg-config --libs nxml)
 DLLIBS_trac += $(shell PKG_CONFIG_PATH=${PKGCONFIGPATH} pkg-config --libs mrss)
 DLLIBS_trac += -lcurl
endif

PLUGIN_TROUT     = @PLUGIN_TROUT@
ifeq (${PLUGIN_TROUT},yes)
 SRCS  += trout.c 
endif

PLUGIN_URL       = @PLUGIN_URL@
ifeq (${PLUGIN_URL},yes)
 SRCS  += url.c
 DLLIBS_url      = -lcurl
endif

OBJS	= ${SRCS:%.c=plugin_%.so}
DEPS	= ${SRCS:.c=.d}

EXTRAS	= 

.PHONY:	clean cleanall ${EMPTY_AUTOMAKE_TARGETS}

all:	${OBJS}

plugin_%.so:	%.c
	${CC} ${CFLAGS} ${CFLAGS_${<:%.c=%}} -fPIC -shared -o $@ $< ${DLLIBS_${<:%.c=%}}

depend:		${DEPS}
${DEPS}:	Makefile

%.d: %.c
	@echo "Making $@ (dependencies for $<)"
	@${CC} -MM ${CFLAGS} ${CFLAGS_${<:%.c=%}} $< | \
	 sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g'  > $@

distclean:	clean

clean:
	[ "${OBJS}" != "" ] && ${RM} ${OBJS}

cleanall:	clean
	${RM} ${DEPS}

install:	install-data install-exec

install-exec:
	[ "${OBJS}" != "" ] && \
	for i in ${OBJS} ; do \
		@INSTALL@ -D -m 755 $$i ${DESTDIR}${pkglibdir}/$$i ; \
	done

install-data:
	[ "${LUASCRIPTS} ${EXTRAS}" != " " ] && \
	for i in ${LUASCRIPTS} ${EXTRAS} ; do \
		@INSTALL@ -D -m 644 $$i ${DESTDIR}${pkglibdir}/$$i ; \
	done

uninstall:
	[ "${OBJS} ${LUASCRIPTS} ${EXTRAS}" != "  " ] && \
	for i in ${OBJS} ${LUASCRIPTS} ${EXTRAS} ; do \
		${RM} ${DESTDIR}${pkglibdir}/$$i ; \
	done

${EMPTY_AUTOMAKE_TARGETS}:

-include ${DEPS}

